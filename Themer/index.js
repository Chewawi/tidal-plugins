import{intercept as N}from"@neptune";import{store as z}from"@neptune";import{intercept as U}from"@neptune";var f=(t,e,n,{timeoutMs:r,cancel:o}={})=>{r??=5e3,o??=!1;let i,s,d=new Promise((u,L)=>{i=u,s=L}),a=U(e,u=>{if(i(u),o)return!0},!0),c=U(n,s,!0),y=setTimeout(()=>s(`${n??e}_TIMEOUT`),r);return t(),d.finally(()=>{clearTimeout(y),a(),c()})};import{store as pe}from"@neptune";var Y=()=>pe.getState()?.playbackControls??{};import{actions as D}from"@neptune";var fe=t=>{let e=d=>{let a=(...c)=>{d(t,...c)};return a.withContext=c=>(...y)=>{d(t,c,...y)},a},n=e(console.log),r=e(console.warn),o=e(console.error),i=e(console.debug),s=(d,a,c)=>{let y=u=>{d(u),a({message:`${t} - ${u}`,category:"OTHER",severity:c})};return y.withContext=u=>{let L=d.withContext(u);return b=>{L(b),b instanceof Error&&(b=b.message),a({message:`${t}.${u} - ${b}`,category:"OTHER",severity:c})}},y};return{log:n,warn:r,err:o,debug:i,msg:{log:s(n,D.message.messageInfo,"INFO"),warn:s(r,D.message.messageWarn,"WARN"),err:s(o,D.message.messageError,"ERROR")}}},m=fe("[lib]");var I=class{static _cache={};static current(e){if(e??=Y()?.playbackContext,e?.actualProductId!==void 0)return this.ensure(e.actualProductId)}static async ensure(e){if(e===void 0)return;let n=this._cache[e];if(n!==void 0)return n;let r=z.getState().content.mediaItems;for(let o in r){let i=r[o]?.item;i?.contentType==="track"&&(this._cache[o]=i)}if(this._cache[e]===void 0){let o=window.location.pathname;await f(()=>neptune.actions.router.replace(`/track/${e}`),["page/IS_DONE_LOADING"],[]).catch(m.warn.withContext(`TrackItemCache.ensure failed to load track ${e}`)),neptune.actions.router.replace(o);let s=z.getState().content.mediaItems[+e]?.item;s?.contentType==="track"&&(this._cache[e]=s)}return this._cache[e]}};var x=(t,e)=>{let n=document.getElementById(e);n||(n=document.createElement("style"),n.id=e,document.head.appendChild(n)),n.innerHTML=t},q=t=>document.getElementById(t);var he=`
.context-button {
	align-items: center;
	display: flex;
	font-weight: 500;
	padding: 20px 16px;
	width: 100%;
    height: 45px;
	flex-grow: 1;
	color: #b878ff;
    position: relative;
}
.context-button:hover {
	background-color: #9e46ff;
	color: #fff;
}
.context-button::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: var(--progress, 0); /* Initially set to 0 */
    background: rgba(255, 255, 255, 0.25); /* Loading bar color */
    z-index: 1;
}
.context-button.loading {
    background-color: #9e46ff;
    cursor: not-allowed;
    color: #fff;
}
.context-button span {
    z-index: 2;
    position: relative;
}
`;x(he,"content-button");import{actions as ne,store as Ce}from"@neptune";var O=(t,e)=>e.some(n=>t instanceof n),H,G;function ye(){return H||(H=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ge(){return G||(G=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var R=new WeakMap,M=new WeakMap,E=new WeakMap;function be(t){let e=new Promise((n,r)=>{let o=()=>{t.removeEventListener("success",i),t.removeEventListener("error",s)},i=()=>{n(h(t.result)),o()},s=()=>{r(t.error),o()};t.addEventListener("success",i),t.addEventListener("error",s)});return E.set(e,t),e}function Ie(t){if(R.has(t))return;let e=new Promise((n,r)=>{let o=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",s),t.removeEventListener("abort",s)},i=()=>{n(),o()},s=()=>{r(t.error||new DOMException("AbortError","AbortError")),o()};t.addEventListener("complete",i),t.addEventListener("error",s),t.addEventListener("abort",s)});R.set(t,e)}var K={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return R.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return h(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function Z(t){K=t(K)}function xe(t){return ge().includes(t)?function(...e){return t.apply($(this),e),h(this.request)}:function(...e){return h(t.apply($(this),e))}}function Te(t){return typeof t=="function"?xe(t):(t instanceof IDBTransaction&&Ie(t),O(t,ye())?new Proxy(t,K):t)}function h(t){if(t instanceof IDBRequest)return be(t);if(M.has(t))return M.get(t);let e=Te(t);return e!==t&&(M.set(t,e),E.set(e,t)),e}var $=t=>E.get(t);function j(t,e,{blocked:n,upgrade:r,blocking:o,terminated:i}={}){let s=indexedDB.open(t,e),d=h(s);return r&&s.addEventListener("upgradeneeded",a=>{r(h(s.result),a.oldVersion,a.newVersion,h(s.transaction),a)}),n&&s.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),d.then(a=>{i&&a.addEventListener("close",()=>i()),o&&a.addEventListener("versionchange",c=>o(c.oldVersion,c.newVersion,c))}).catch(()=>{}),d}var we=["get","getKey","getAll","getAllKeys","count"],Se=["put","add","delete","clear"],B=new Map;function J(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(B.get(e))return B.get(e);let n=e.replace(/FromIndex$/,""),r=e!==n,o=Se.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(o||we.includes(n)))return;let i=async function(s,...d){let a=this.transaction(s,o?"readwrite":"readonly"),c=a.store;return r&&(c=c.index(d.shift())),(await Promise.all([c[n](...d),o&&a.done]))[0]};return B.set(e,i),i}Z(t=>({...t,get:(e,n,r)=>J(e,n)||t.get(e,n,r),has:(e,n)=>!!J(e,n)||t.has(e,n)}));var Ee=["continue","continuePrimaryKey","advance"],X={},V=new WeakMap,ee=new WeakMap,ke={get(t,e){if(!Ee.includes(e))return t[e];let n=X[e];return n||(n=X[e]=function(...r){V.set(this,ee.get(this)[e](...r))}),n}};async function*ve(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;let n=new Proxy(e,ke);for(ee.set(n,e),E.set(n,$(e));e;)yield n,e=await(V.get(n)||e.continue()),V.delete(n)}function Q(t,e){return e===Symbol.asyncIterator&&O(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&O(t,[IDBIndex,IDBObjectStore])}Z(t=>({...t,get(e,n,r){return Q(e,n)?ve:t.get(e,n,r)},has(e,n){return Q(e,n)||t.has(e,n)}}));var k=class{constructor(e){this.avalibleSlots=e}queued=[];async obtain(){let e=!1,n=()=>{e||(e=!0,this.avalibleSlots++,this.queued.shift()?.())};return this.avalibleSlots>0?(this.avalibleSlots--,n):new Promise(r=>{this.queued.push(()=>{this.avalibleSlots--,r(n)})})}};var te="@inrixia/sharedStorage",p=class t{constructor(e,n){this.storeName=e;t.openDB(e,n)}static db;static openSema=new k(1);static async openDB(e,n){let r=await this.openSema.obtain();try{let o=s=>async()=>{await s.close(),this.openDB(e,n)};this.db=j(te).then(async s=>(s.addEventListener("versionchange",o(s)),s.objectStoreNames.contains(e)?s:(await s.close(),j(te,s.version+1,{blocking:o(s),upgrade(d){d.createObjectStore(e,n)}}))));let i=await this.db;i.addEventListener("versionchange",o(i))}finally{r()}}static close(){return this.db?.then(e=>e.close())}add(e,n){return t.db.then(r=>r.add(this.storeName,e,n))}clear(){return t.db.then(e=>e.clear(this.storeName))}count(e){return t.db.then(n=>n.count(this.storeName,e))}delete(e){return t.db.then(n=>n.delete(this.storeName,e))}get(e){return t.db.then(n=>n.get(this.storeName,e))}getAll(e,n){return t.db.then(r=>r.getAll(this.storeName,e,n))}getAllKeys(e,n){return t.db.then(r=>r.getAllKeys(this.storeName,e,n))}getKey(e){return t.db.then(n=>n.getKey(this.storeName,e))}put(e,n){return t.db.then(r=>r.put(this.storeName,e,n))}};var nt=1e3*60*60*24,v=class{static _cache={};static _trackItemsCache=new p("AlbumCache.trackItems",{keyPath:"albumId"});static async get(e){if(e===void 0)return;let n=this._cache[e];if(n!==void 0)return n;let r=Ce.getState().content.albums;for(let o in r)this._cache[o]=r[o];if(this._cache[e]===void 0){let o=await f(()=>ne.content.loadAlbum({albumId:e}),["content/LOAD_ALBUM_SUCCESS"],[]).then(i=>i?.[0].album).catch(m.warn.withContext("AlbumCache.get"));o!==void 0&&(this._cache[e]=o)}return this._cache[e]}static async getTrackItems(e){if(e===void 0)return;let n=await this._trackItemsCache.get(e),r=this.updateTrackItems(e);return n?.trackItems!==void 0?n.trackItems:r}static async updateTrackItems(e){let n=await f(()=>ne.content.loadAllAlbumMediaItems({albumId:e}),["content/LOAD_ALL_ALBUM_MEDIA_ITEMS_SUCCESS"],["content/LOAD_ALL_ALBUM_MEDIA_ITEMS_FAIL"],{timeoutMs:2e3}).catch(m.warn.withContext("PlaylistCache.getTrackItems.interceptPromise"));if(n?.[0]?.mediaItems===void 0)return(await this._trackItemsCache.get(e))?.trackItems;let r=Array.from((n?.[0]?.mediaItems).map(o=>o?.item).filter(o=>o?.contentType==="track"));return await this._trackItemsCache.put({albumId:e,trackItems:r}),r}};import{actions as Ae}from"@neptune";var C=class extends p{maxAge;constructor(e,n){let{maxAge:r,storeSchema:o}=n??{};super(e,o),this.maxAge=r}setExpires(e,n){if(n!==void 0)e.__expires=n;else if(this.maxAge!==void 0)e.__expires=Date.now()+this.maxAge;else throw new Error("maxAge or expires must be set!")}clearExpires(e){delete e.__expires}isTooOld(e){return e?.__expires===void 0?!0:Date.now()>e.__expires}async add(e,n){return this.setExpires(e),super.add(e,n)}async put(e,n){return this.setExpires(e),super.put(e,n)}async addExpires(e,n,r){return this.setExpires(e,n),super.add(e,r)}async putExpires(e,n,r){return this.setExpires(e,n),super.put(e,r)}async get(e){let n=await super.get(e);if(!this.isTooOld(n))return this.clearExpires(n),n}async getWithExpiry(e){let n=await super.get(e);if(n===void 0)return{value:void 0,expires:void 0,expired:void 0};let r=n.__expires,o=this.isTooOld(n);return this.clearExpires(n),{value:n,expires:r,expired:o}}async getAll(e,n){return(await super.getAll(e,n)).filter(this.isTooOld.bind(this)).map(this.clearExpires.bind(this))}};var A=class{static _trackItemsCache=new C("PlaylistCache.trackItems",{maxAge:3e4,storeSchema:{keyPath:"playlistUUID"}});static async getTrackItems(e){if(e===void 0)return;let n=await this._trackItemsCache.get(e),r=this.updateTrackItems(e);return n?.trackItems!==void 0?n.trackItems:r}static async updateTrackItems(e){let n=await f(()=>Ae.content.loadListItemsPage({loadAll:!0,listName:`playlists/${e}`,listType:"mediaItems"}),["content/LOAD_LIST_ITEMS_PAGE_SUCCESS"],["content/LOAD_LIST_ITEMS_PAGE_FAIL"],{timeoutMs:2e3}).catch(m.warn.withContext("PlaylistCache.getTrackItems.interceptPromise"));if(n?.[0]?.items===void 0)return(await this._trackItemsCache.get(e))?.trackItems;let r=Array.from((n?.[0]?.items).map(o=>o?.item).filter(o=>o?.contentType==="track"));return await this._trackItemsCache.put({playlistUUID:e,trackItems:r}),r}};var P=class t{static _intercepts=[N(["contextMenu/OPEN_MEDIA_ITEM"],([e])=>{(async()=>this._onOpen({type:"TRACK"},await this.getTrackItems([e.id])))()}),N(["contextMenu/OPEN_MULTI_MEDIA_ITEM"],([e])=>{(async()=>this._onOpen({type:"TRACK"},await this.getTrackItems(e.ids)))()}),N("contextMenu/OPEN",([e])=>{switch(e.type){case"ALBUM":{v.getTrackItems(e.id).then(n=>{n!==void 0&&this._onOpen({type:"ALBUM",albumId:e.id},n)});break}case"PLAYLIST":{A.getTrackItems(e.id).then(n=>{n!==void 0&&this._onOpen({type:"PLAYLIST",playlistId:e.id},n)});break}}})];static async getTrackItems(e){return(await Promise.all(e.map(I.ensure.bind(I)))).filter(r=>r!==void 0)}static _onOpen(e,n){setTimeout(async()=>{let r=0,o=document.querySelector('[data-type="list-container__context-menu"]');for(;o===null&&r<50;)await new Promise(i=>setTimeout(i,50)),o=document.querySelector('[data-type="list-container__context-menu"]');if(o!==null)for(let i of this._listeners)i(e,o,n).catch(m.err.withContext("ContextMenu.listener"))})}static _listeners=[];static onOpen(e){t._listeners.push(e)}static onUnload(){this._intercepts.forEach(e=>e())}};var re=async()=>{await p.close(),await P.onUnload()};import{storage as T}from"@plugin";var oe=t=>(Object.keys(t).forEach(e=>T[e]??=t[e]),T),se=t=>{T.settings??={};for(let e of Object.keys(t))T.settings[e]??=t[e];return T.settings};import{html as Le}from"@neptune/voby";import{html as _e}from"@neptune/voby";import{html as Pe}from"@neptune/voby";var ie=({children:t,tooltip:e})=>Pe`
	<div style="margin-bottom: 15px;display: flex;justify-content: space-between;align-items: center;" title="${e}">${t}</div>
`;var ae=({checked:t,onClick:e,title:n,tooltip:r})=>(t??=!1,_e`
		<${ie} tooltip=${r}>
			<label for="switch-${n}" style="font-size: 1.2em;margin-bottom: 5px;">${n}</label>
			<input id="switch-${n}" class="neptune-switch-checkbox" type="checkbox" checked=${t} />
			<span onClick=${e} class="neptune-switch" />
		<//>
	`);var g=se({showEditor:!0}),De=()=>Le`<div>
	<${ae}
		checked=${g.showEditor}
		onClick=${()=>{g.showEditor=!g.showEditor,g.showEditor?l.style.display="":l.style.display="none"}}
		title="Show editor"
	/>
</div>`;var ce=oe({css:""}),W="__Themer__Draggable",_=`${W}__Style`,de=()=>{let t=document.getElementById(W);if(!t){t=document.createElement("div"),t.id=W,t.style.width="300px",t.style.height="200px",t.style.position="absolute",t.style.top="100px",t.style.left="100px",t.style.border="1px solid #ccc",t.style.backgroundColor="#f9f9f9",t.style.resize="both",t.style.overflow="auto",t.style.padding="10px",t.style.cursor="move",t.style.zIndex="1000",t.style.borderRadius="8px",t.style.backgroundColor="#5b5b5b",t.style.borderWidth="0px";let e=document.createElement("textarea");e.style.width="100%",e.style.height="100%",e.style.boxSizing="border-box",e.style.borderRadius="8px",e.style.borderWidth="0px",e.style.backgroundColor="#181818",e.style.color="white",e.style.padding="10px",e.style.boxShadow="inset 0 0 20px 0px rgba(0, 0, 0, 0.5)",e.rows=10,e.cols=50,e.placeholder="Enter css styles here...",x(e.value=ce.css,_),e.addEventListener("keyup",n=>x(ce.css=n.target.value,_)),t.appendChild(e),document.body.appendChild(t)}return t.style.display=g.showEditor?"":"none",t};var l=de(),F=!1,w,S,le=t=>{let e=l.getBoundingClientRect().top,n=l.getBoundingClientRect().left;w=t.clientX-n,S=t.clientY-e,(w<20||w>e-20&&w<e-2||S<20||S>e-20&&S<e-2)&&(F=!0)},ue=t=>{F&&(l.style.left=`${t.clientX-w}px`,l.style.top=`${t.clientY-S}px`)},me=()=>{F=!1};l.addEventListener("mousedown",le);document.addEventListener("mousemove",ue);document.addEventListener("mouseup",me);var Wt=()=>{l.removeEventListener("mousedown",le),document.removeEventListener("mousemove",ue),document.removeEventListener("mouseup",me),l.remove(),q(_)?.remove(),re()};export{De as Settings,l as draggable,Wt as onUnload};
